# Apache configuration for Clinic System with SSL
# This configuration requires mod_ssl, mod_proxy, mod_proxy_http, and mod_headers

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com

    # Let's Encrypt ACME challenge
    Alias /.well-known/acme-challenge/ /var/www/certbot/.well-known/acme-challenge/
    <Directory /var/www/certbot/.well-known/acme-challenge/>
        Require all granted
    </Directory>

    # Redirect all other requests to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS server
<VirtualHost *:443>
    ServerName example.com
    ServerAlias www.example.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # HSTS header
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Security headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "same-origin"

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/clinic_system_error.log
    CustomLog ${APACHE_LOG_DIR}/clinic_system_access.log combined

    # Static files
    Alias /static /path/to/diabetes_clinic_appointments/staticfiles
    <Directory /path/to/diabetes_clinic_appointments/staticfiles>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
    </Directory>

    # Media files
    Alias /media /path/to/diabetes_clinic_appointments/media
    <Directory /path/to/diabetes_clinic_appointments/media>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 7 days"
    </Directory>

    # Proxy to Gunicorn
    ProxyPreserveHost On
    ProxyPass /static !
    ProxyPass /media !
    ProxyPass / unix:/run/gunicorn-clinic-system.sock|http://example.com/
    ProxyPassReverse / unix:/run/gunicorn-clinic-system.sock|http://example.com/

    # Pass headers for Django
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
</VirtualHost>

# SSL Settings (global)
SSLUseStapling on
SSLStaplingCache shmcb:/var/run/apache2/stapling_cache(128000)
